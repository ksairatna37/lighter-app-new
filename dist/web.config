<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <handlers>
      <!-- Handler for Node.js backend API -->
      <add name="iisnode" path="server/api.js" verb="*" modules="iisnode" />
    </handlers>

    <!-- Explicitly set the default document to the SPA entry point in dist -->
     <defaultDocument enabled="true">
        <files>
            <clear />
            <add value="dist/index.html" />
        </files>
    </defaultDocument>

    <rewrite>
      <rules>
        <!-- Rule 1: Handle API requests first -->
        <rule name="API Routes" stopProcessing="true">
          <match url="^api/(.*)$" />
          <!-- Rewrite to the Node.js API entry point -->
          <action type="Rewrite" url="server/api.js" />
        </rule>

        <!-- Rule 2: Serve static files from the 'dist' folder if they exist -->
        <!-- This rule might become less critical if defaultDocument works, -->
        <!-- but keep it for assets not directly requested by index.html -->
        <rule name="Static Files" stopProcessing="true">
          <match url="^(.*)$" />
          <conditions logicalGrouping="MatchAll">
             <!-- Check if the corresponding file exists within the 'dist' folder relative to the site root -->
            <add input="{DOCUMENT_ROOT}/dist/{R:1}" matchType="IsFile" />
          </conditions>
          <!-- Rewrite to the actual file path within 'dist' -->
          <action type="Rewrite" url="dist/{R:1}" />
        </rule>

        <!-- Rule 3: Fallback for SPA routing - rewrite to dist/index.html -->
        <!-- This rule handles deep links / client-side routes -->
        <rule name="SPA Fallback" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <!-- Ensure it's not an API call (already handled by Rule 1) -->
             <add input="{REQUEST_URI}" pattern="^/api/" negate="true" />
             <!-- Check if it's NOT a file in the /dist directory -->
            <add input="{DOCUMENT_ROOT}/dist{REQUEST_URI}" matchType="IsFile" negate="true" />
             <!-- Check if it's NOT a directory in the /dist directory -->
            <add input="{DOCUMENT_ROOT}/dist{REQUEST_URI}" matchType="IsDirectory" negate="true" />
          </conditions>
          <!-- Rewrite to the SPA entry point in the 'dist' folder -->
          <action type="Rewrite" url="dist/index.html" />
        </rule>
      </rules>
    </rewrite>

  </system.webServer>
</configuration>